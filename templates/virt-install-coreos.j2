#!/bin/bash

args='nomodeset '
args+='coreos.inst=yes '
args+='coreos.inst.install_dev=vda '
args+='coreos.inst.image_url={{ rhcos_metal_bios }} '
args+='coreos.inst.ignition_url={{ rhcos_ignition }} '
args+='ip={{ vm_ip }}::{{ gateway }}:{{ mask }}:{{ vm_name }}.{{ cluster_name }}.{{ dns_domain }}:ens3:none nameserver={{ dns_server_ip }} '
args+='rd.neednet=1'

# {{ vm_type }} Node
sudo qemu-img create -f qcow2 {{ kvm_host_libvirt_dir }}/{{ vm_name }}.qcow2 {{ hd_size }}
sudo virt-format --format=qcow2 -a {{ kvm_host_libvirt_dir }}/{{ vm_name }}.qcow2

sudo virt-install --name {{ vm_name }} \
  --disk {{ kvm_host_libvirt_dir }}/{{ vm_name }}.qcow2 --memory {{ memory_size }} --vcpus {{ cpu_size }} \
  --os-type linux --os-variant rhel7 \
  --network network={{ libvirt_network_name }},mac={{ vm_mac }},model=e1000 --noreboot --noautoconsole\
  --location {{ virtinstall_dir }} \
  --extra-args="${args}"
